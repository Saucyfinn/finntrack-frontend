<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FinnTrack - Live Map</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1e3a5f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    #map {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
      color: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
    }
    .brand {
      font-size: 20px;
      font-weight: 700;
    }
    .status {
      display: flex;
      gap: 20px;
      font-size: 14px;
    }
    .status-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .dot-boat { background: #ff9500; }
    .dot-phone { background: #667eea; }
    .dot-ws { background: #34c759; }
    .dot-ws.disconnected { background: #ff3b30; }
    .sidebar {
      position: fixed;
      top: 55px;
      right: 10px;
      width: 300px;
      max-height: calc(100vh - 75px);
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      z-index: 1000;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid #eee;
      font-weight: 600;
      background: #f8f9fa;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #eee;
    }
    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      font-size: 14px;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab.active {
      border-bottom-color: #1e3a5f;
      color: #1e3a5f;
      font-weight: 600;
    }
    .list {
      flex: 1;
      overflow-y: auto;
      max-height: 350px;
    }
    .item {
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
    }
    .item:hover {
      background: #f8f8f8;
    }
    .item-name {
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .item-info {
      font-size: 12px;
      color: #666;
    }
    .badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }
    .badge-boat { background: #fff3e0; color: #e65100; }
    .badge-phone { background: #ede7f6; color: #5e35b1; }
    .empty-state {
      padding: 40px 20px;
      text-align: center;
      color: #999;
    }
    .empty-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    .home-link {
      display: block;
      padding: 16px;
      text-align: center;
      background: #1e3a5f;
      color: white;
      text-decoration: none;
      font-weight: 600;
    }
    @media (max-width: 600px) {
      .sidebar {
        width: calc(100% - 20px);
        left: 10px;
        top: auto;
        bottom: 10px;
        max-height: 250px;
      }
      .status { display: none; }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <div class="header">
    <div class="brand">‚õµ FinnTrack</div>
    <div class="status">
      <div class="status-item">
        <div class="dot dot-boat"></div>
        <span><span id="boatCount">0</span> boats</span>
      </div>
      <div class="status-item">
        <div class="dot dot-phone"></div>
        <span><span id="phoneCount">0</span> phones</span>
      </div>
      <div class="status-item">
        <div class="dot dot-ws" id="wsDot"></div>
        <span>Live</span>
      </div>
    </div>
  </div>
  
  <div class="sidebar">
    <div class="tabs">
      <div class="tab active" data-tab="all">All</div>
      <div class="tab" data-tab="boats">Boats</div>
      <div class="tab" data-tab="phones">Phones</div>
    </div>
    <div class="list" id="itemList">
      <div class="empty-state">
        <div class="empty-icon">üì°</div>
        <div>No devices connected</div>
      </div>
    </div>
    <a href="/" class="home-link">‚Üê Back to Home</a>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const initLat = parseFloat(params.get('lat')) || -27.4667;
    const initLon = parseFloat(params.get('lon')) || 153.1833;
    const initZoom = parseInt(params.get('zoom')) || 14;
    const followDevice = params.get('follow');
    
    const map = L.map('map').setView([initLat, initLon], initZoom);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);
    
    const boatMarkers = new Map();
    const phoneMarkers = new Map();
    const boats = new Map();
    const phones = new Map();
    
    const itemList = document.getElementById('itemList');
    const boatCount = document.getElementById('boatCount');
    const phoneCount = document.getElementById('phoneCount');
    const wsDot = document.getElementById('wsDot');
    
    let activeTab = 'all';
    let shouldFollowDevice = !!followDevice;
    
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        activeTab = tab.dataset.tab;
        updateList();
      });
    });
    
    const nationalColors = {
      'AUS': { bg: '#FFD700', text: '#000' },
      'NZL': { bg: '#000000', text: '#fff' },
      'GBR': { bg: '#012169', text: '#fff' },
      'USA': { bg: '#3C3B6E', text: '#fff' },
      'GER': { bg: '#000000', text: '#FFCC00' },
      'FRA': { bg: '#0055A4', text: '#fff' },
      'ITA': { bg: '#009246', text: '#fff' },
      'ESP': { bg: '#AA151B', text: '#F1BF00' },
      'NED': { bg: '#FF6600', text: '#fff' },
      'SWE': { bg: '#006AA7', text: '#FECC00' },
      'DEN': { bg: '#C8102E', text: '#fff' },
      'CAN': { bg: '#FF0000', text: '#fff' },
      'JPN': { bg: '#BC002D', text: '#fff' },
      'POL': { bg: '#DC143C', text: '#fff' },
      'FIN': { bg: '#003580', text: '#fff' },
      'default': { bg: '#1e3a5f', text: '#fff' }
    };
    
    function getCountryFromSail(sailNum) {
      if (!sailNum) return 'default';
      const match = sailNum.match(/^([A-Z]{2,3})/i);
      return match ? match[1].toUpperCase() : 'default';
    }
    
    function createBoatIcon(sailNum) {
      const country = getCountryFromSail(sailNum);
      const colors = nationalColors[country] || nationalColors['default'];
      const displayNum = sailNum ? sailNum.replace(/^[A-Z]{2,3}\s*/i, '').trim() : '?';
      
      return L.divIcon({
        className: 'boat-marker',
        html: `<div style="position: relative; width: 44px; height: 52px;">
          <svg viewBox="0 0 44 52" width="44" height="52">
            <path d="M22 2 L40 18 L38 42 Q22 50 6 42 L4 18 Z" 
                  fill="${colors.bg}" stroke="white" stroke-width="2"/>
            <polygon points="22,8 32,20 22,18 12,20" fill="white" opacity="0.9"/>
          </svg>
          <div style="position: absolute; bottom: 8px; left: 0; right: 0;
            text-align: center; font-size: 11px; font-weight: bold;
            color: ${colors.text}; text-shadow: 0 0 2px rgba(255,255,255,0.5);">${displayNum}</div>
        </div>`,
        iconSize: [44, 52],
        iconAnchor: [22, 52]
      });
    }
    
    function createPhoneIcon(sailNum) {
      return createBoatIcon(sailNum);
    }
    
    function updateBoat(boat) {
      boats.set(boat.boatId, boat);
      const sailNum = boat.boatId || boat.name || '';
      
      if (boatMarkers.has(boat.boatId)) {
        const marker = boatMarkers.get(boat.boatId);
        marker.setLatLng([boat.lat, boat.lon]);
        marker.setIcon(createBoatIcon(sailNum));
      } else {
        const marker = L.marker([boat.lat, boat.lon], { icon: createBoatIcon(sailNum) })
          .addTo(map)
          .bindPopup(`<b>${boat.name || boat.boatId}</b><br>Speed: ${(boat.sog || 0).toFixed(1)} kn`);
        boatMarkers.set(boat.boatId, marker);
      }
      
      updateCounts();
      updateList();
    }
    
    function updatePhone(phone) {
      phones.set(phone.deviceId, phone);
      const sailNum = phone.name || phone.deviceId || '';
      
      if (phoneMarkers.has(phone.deviceId)) {
        const marker = phoneMarkers.get(phone.deviceId);
        marker.setLatLng([phone.lat, phone.lon]);
        marker.setIcon(createPhoneIcon(sailNum));
      } else {
        const marker = L.marker([phone.lat, phone.lon], { icon: createPhoneIcon(sailNum) })
          .addTo(map)
          .bindPopup(`<b>${phone.name}</b><br>Speed: ${((phone.speed || 0) * 1.94384).toFixed(1)} kn`);
        phoneMarkers.set(phone.deviceId, marker);
      }
      
      updateCounts();
      updateList();
    }
    
    function removeBoat(boatId) {
      boats.delete(boatId);
      if (boatMarkers.has(boatId)) {
        map.removeLayer(boatMarkers.get(boatId));
        boatMarkers.delete(boatId);
      }
      updateCounts();
      updateList();
    }
    
    function removePhone(deviceId) {
      phones.delete(deviceId);
      if (phoneMarkers.has(deviceId)) {
        map.removeLayer(phoneMarkers.get(deviceId));
        phoneMarkers.delete(deviceId);
      }
      updateCounts();
      updateList();
    }
    
    function updateCounts() {
      boatCount.textContent = boats.size;
      phoneCount.textContent = phones.size;
    }
    
    function updateList() {
      let items = [];
      
      if (activeTab === 'all' || activeTab === 'boats') {
        boats.forEach((b, id) => {
          items.push({ type: 'boat', id, name: b.name || b.boatId, info: `${(b.sog || 0).toFixed(1)} kn`, lat: b.lat, lon: b.lon });
        });
      }
      
      if (activeTab === 'all' || activeTab === 'phones') {
        phones.forEach((p, id) => {
          items.push({ type: 'phone', id, name: p.name, info: `${((p.speed || 0) * 3.6).toFixed(1)} km/h`, lat: p.lat, lon: p.lon });
        });
      }
      
      if (items.length === 0) {
        itemList.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üì°</div>
            <div>No ${activeTab === 'all' ? 'devices' : activeTab} connected</div>
          </div>
        `;
        return;
      }
      
      itemList.innerHTML = items.map(item => `
        <div class="item" onclick="focusItem('${item.type}', '${item.id}')">
          <div class="item-name">
            ${item.type === 'boat' ? '‚õµ' : 'üì±'} ${item.name}
            <span class="badge badge-${item.type}">${item.type}</span>
          </div>
          <div class="item-info">${item.info} | ${item.lat.toFixed(4)}, ${item.lon.toFixed(4)}</div>
        </div>
      `).join('');
    }
    
    window.focusItem = function(type, id) {
      const markers = type === 'boat' ? boatMarkers : phoneMarkers;
      if (markers.has(id)) {
        const marker = markers.get(id);
        map.setView(marker.getLatLng(), 16);
        marker.openPopup();
      }
    };
    
    let ws;
    function connect() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}/ws`);
      
      ws.onopen = () => {
        wsDot.classList.remove('disconnected');
      };
      
      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        
        if (msg.type === 'init') {
          (msg.boats || msg.devices || []).forEach(updateBoat);
          (msg.phones || []).forEach(updatePhone);
        } else if (msg.type === 'boat_update') {
          updateBoat(msg.boat);
        } else if (msg.type === 'device_update') {
          updateBoat(msg.device || msg.boat);
          if (shouldFollowDevice && msg.device && (msg.device.deviceId === followDevice || msg.device.boatId === followDevice)) {
            map.setView([msg.device.lat, msg.device.lon], map.getZoom());
          }
        } else if (msg.type === 'phone_update') {
          updatePhone(msg.phone);
        } else if (msg.type === 'boat_disconnect' || msg.type === 'device_disconnect') {
          removeBoat(msg.boatId || msg.deviceId);
        } else if (msg.type === 'phone_disconnect') {
          removePhone(msg.deviceId);
        }
      };
      
      ws.onclose = () => {
        wsDot.classList.add('disconnected');
        setTimeout(connect, 2000);
      };
    }
    
    connect();
    
    async function loadInitial() {
      try {
        const [boatsRes, phonesRes] = await Promise.all([
          fetch('/boats'),
          fetch('/api/phones')
        ]);
        const boatsData = await boatsRes.json();
        const phonesData = await phonesRes.json();
        (boatsData.boats || []).forEach(updateBoat);
        (phonesData.phones || []).forEach(updatePhone);
      } catch (e) {
        console.error('Failed to load initial data');
      }
    }
    
    loadInitial();
  </script>
</body>
</html>
