<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    #map {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    .brand {
      font-size: 20px;
      font-weight: 700;
      color: #667eea;
    }
    .status {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #34c759;
    }
    .status-dot.disconnected { background: #ff3b30; }
    .phone-count {
      font-weight: 600;
      color: #333;
    }
    .sidebar {
      position: fixed;
      top: 60px;
      right: 10px;
      width: 280px;
      max-height: calc(100vh - 80px);
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      z-index: 1000;
      overflow: hidden;
    }
    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid #eee;
      font-weight: 600;
    }
    .phone-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .phone-item {
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
    }
    .phone-item:hover {
      background: #f8f8f8;
    }
    .phone-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .phone-info {
      font-size: 12px;
      color: #666;
    }
    .empty-state {
      padding: 40px 20px;
      text-align: center;
      color: #999;
    }
    .empty-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    .home-link {
      display: block;
      padding: 16px;
      text-align: center;
      background: #667eea;
      color: white;
      text-decoration: none;
      font-weight: 600;
    }
    @media (max-width: 600px) {
      .sidebar {
        width: calc(100% - 20px);
        left: 10px;
        top: auto;
        bottom: 10px;
        max-height: 200px;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <div class="header">
    <div class="brand">üìç Phone Tracker</div>
    <div class="status">
      <div class="status-dot" id="statusDot"></div>
      <span class="phone-count"><span id="phoneCount">0</span> phones connected</span>
    </div>
  </div>
  
  <div class="sidebar">
    <div class="sidebar-header">Connected Phones</div>
    <div class="phone-list" id="phoneList">
      <div class="empty-state">
        <div class="empty-icon">üì±</div>
        <div>No phones connected yet</div>
        <div style="font-size:12px;margin-top:8px;">Open the Connect page on your phone</div>
      </div>
    </div>
    <a href="/" class="home-link">‚Üê Back to Home</a>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([0, 0], 2);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    
    const markers = new Map();
    const phoneList = document.getElementById('phoneList');
    const phoneCount = document.getElementById('phoneCount');
    const statusDot = document.getElementById('statusDot');
    
    function createPhoneIcon(color = '#667eea') {
      return L.divIcon({
        className: 'phone-marker',
        html: `<div style="
          width: 36px;
          height: 36px;
          background: ${color};
          border: 3px solid white;
          border-radius: 50%;
          box-shadow: 0 2px 10px rgba(0,0,0,0.3);
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 16px;
        ">üì±</div>`,
        iconSize: [36, 36],
        iconAnchor: [18, 18]
      });
    }
    
    function updatePhone(phone) {
      const { deviceId, name, lat, lon, speed, lastUpdate } = phone;
      
      if (markers.has(deviceId)) {
        const marker = markers.get(deviceId);
        marker.setLatLng([lat, lon]);
        marker.setPopupContent(createPopup(phone));
      } else {
        const marker = L.marker([lat, lon], { icon: createPhoneIcon() })
          .addTo(map)
          .bindPopup(createPopup(phone));
        markers.set(deviceId, marker);
        
        if (markers.size === 1) {
          map.setView([lat, lon], 15);
        }
      }
      
      updatePhoneList();
    }
    
    function createPopup(phone) {
      const speed = phone.speed ? (phone.speed * 3.6).toFixed(1) + ' km/h' : 'Stationary';
      const updated = new Date(phone.lastUpdate).toLocaleTimeString();
      return `
        <strong>${phone.name}</strong><br>
        Speed: ${speed}<br>
        Updated: ${updated}
      `;
    }
    
    function removePhone(deviceId) {
      if (markers.has(deviceId)) {
        map.removeLayer(markers.get(deviceId));
        markers.delete(deviceId);
      }
      updatePhoneList();
    }
    
    function updatePhoneList() {
      const phones = Array.from(markers.keys());
      phoneCount.textContent = phones.length;
      
      if (phones.length === 0) {
        phoneList.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üì±</div>
            <div>No phones connected yet</div>
            <div style="font-size:12px;margin-top:8px;">Open the Connect page on your phone</div>
          </div>
        `;
        return;
      }
      
      phoneList.innerHTML = phones.map(deviceId => {
        const marker = markers.get(deviceId);
        const latlng = marker.getLatLng();
        const popup = marker.getPopup().getContent();
        const nameMatch = popup.match(/<strong>([^<]+)<\/strong>/);
        const name = nameMatch ? nameMatch[1] : deviceId;
        
        return `
          <div class="phone-item" onclick="focusPhone('${deviceId}')">
            <div class="phone-name">üì± ${name}</div>
            <div class="phone-info">${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}</div>
          </div>
        `;
      }).join('');
    }
    
    window.focusPhone = function(deviceId) {
      if (markers.has(deviceId)) {
        const marker = markers.get(deviceId);
        map.setView(marker.getLatLng(), 16);
        marker.openPopup();
      }
    };
    
    let ws;
    let reconnectTimeout;
    
    function connect() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}/ws`);
      
      ws.onopen = () => {
        console.log('WebSocket connected');
        statusDot.classList.remove('disconnected');
      };
      
      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        
        if (msg.type === 'init') {
          msg.phones.forEach(updatePhone);
        } else if (msg.type === 'update') {
          updatePhone(msg.phone);
        } else if (msg.type === 'disconnect') {
          removePhone(msg.deviceId);
        }
      };
      
      ws.onclose = () => {
        console.log('WebSocket disconnected, reconnecting...');
        statusDot.classList.add('disconnected');
        reconnectTimeout = setTimeout(connect, 2000);
      };
      
      ws.onerror = (err) => {
        console.error('WebSocket error:', err);
        ws.close();
      };
    }
    
    connect();
    
    async function loadInitialPhones() {
      try {
        const res = await fetch('/api/phones');
        const data = await res.json();
        data.phones.forEach(updatePhone);
      } catch (e) {
        console.error('Failed to load phones:', e);
      }
    }
    
    loadInitialPhones();
  </script>
</body>
</html>
