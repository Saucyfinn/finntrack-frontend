<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>FinnTrack – Join Race</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        main {
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
        }

        .container {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin: 0 0 20px 0;
            font-size: 1.5rem;
            text-align: center;
            color: var(--brand);
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .hint {
            font-weight: normal;
            color: #666;
            font-size: 0.75rem;
        }

        input, select {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--brand);
        }

        select[multiple] {
            height: auto;
            min-height: 120px;
        }

        .btn-row {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary {
            background: #34c759;
            color: #fff;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-danger {
            background: #ff3b30;
            color: #fff;
            display: none;
        }

        .btn-secondary {
            background: var(--brand);
            color: #fff;
        }

        .btn-muted {
            background: #8e8e93;
            color: #fff;
        }

        .status-box {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.875rem;
        }

        .status-row:last-child {
            margin-bottom: 0;
        }

        .status-label {
            color: #666;
        }

        .status-value {
            font-weight: 600;
        }

        .status-ok {
            color: #34c759;
        }

        .status-error {
            color: #ff3b30;
        }

        .status-pending {
            color: #ff9500;
        }

        .error-msg {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            display: none;
            font-size: 0.875rem;
        }

        .coordinates {
            font-family: monospace;
            font-size: 0.75rem;
            color: #666;
            text-align: center;
            margin-top: 12px;
        }

        .back-link {
            display: block;
            text-align: center;
            margin-top: 20px;
            color: var(--brand);
            text-decoration: none;
            font-size: 0.875rem;
        }

        .event-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 12px;
            background: #e7f3ff;
            border-radius: 8px;
        }

        .event-info h2 {
            margin: 0 0 4px 0;
            font-size: 1rem;
            color: var(--brand);
        }

        .event-info p {
            margin: 0;
            color: #666;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>

<header>
    <div class="brand">FinnTrack</div>
    <nav>
        <a href="/">Live</a>
        <a href="/replay">Replay</a>
        <a href="/analytics">Analytics</a>
        <a class="active" href="/join">Join Race</a>
    </nav>
</header>

<main>
    <div class="container">
        <h1>Join Race</h1>

        <div id="eventInfo" class="event-info">
            <h2 id="eventName">Loading...</h2>
            <p id="eventDetails">Loading event details...</p>
        </div>

        <label>Select Races <span class="hint">(hold Ctrl/Cmd for multiple)</span></label>
        <select id="raceSelect" multiple size="5">
            <option value="">Loading races...</option>
        </select>

        <div class="btn-row">
            <button type="button" id="selectAllBtn" class="btn btn-secondary">Select All</button>
            <button type="button" id="clearSelectionBtn" class="btn btn-muted">Clear</button>
        </div>

        <label for="entrySelect">Select Your Entry</label>
        <select id="entrySelect">
            <option value="">-- Select from fleet or enter manually --</option>
        </select>

        <label for="boatId">Boat ID / Sail Number</label>
        <input type="text" id="boatId" placeholder="e.g. AUS 123" required>

        <label for="boatName">Skipper Name</label>
        <input type="text" id="boatName" placeholder="e.g. John Smith">

        <button class="btn btn-primary" id="startBtn" style="width:100%">Start Tracking</button>
        <button class="btn btn-danger" id="stopBtn" style="width:100%">Stop Tracking</button>

        <div class="error-msg" id="errorMsg"></div>

        <div class="status-box">
            <div class="status-row">
                <span class="status-label">GPS Permission</span>
                <span class="status-value" id="gpsStatus">Not requested</span>
            </div>
            <div class="status-row">
                <span class="status-label">Tracking</span>
                <span class="status-value" id="trackingStatus">Stopped</span>
            </div>
            <div class="status-row">
                <span class="status-label">Updates Sent</span>
                <span class="status-value" id="updateCount">0</span>
            </div>
            <div class="status-row">
                <span class="status-label">Last Sent</span>
                <span class="status-value" id="lastSent">—</span>
            </div>
        </div>

        <div class="coordinates" id="coordinates">—</div>

        <a href="/help" class="back-link">Need help setting up tracking?</a>
        <a href="/" class="back-link">← Back to Live Viewer</a>
    </div>
</main>

<script src="/js/config.js"></script>
<script src="/js/api.js"></script>
<script>
(() => {
    const API_BASE = FinnAPI.apiBase;
    const API_KEY = "finn123";

    const raceSelect = document.getElementById("raceSelect");
    const selectAllBtn = document.getElementById("selectAllBtn");
    const clearSelectionBtn = document.getElementById("clearSelectionBtn");
    const entrySelect = document.getElementById("entrySelect");
    const boatIdInput = document.getElementById("boatId");
    const boatNameInput = document.getElementById("boatName");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const errorMsg = document.getElementById("errorMsg");
    const gpsStatus = document.getElementById("gpsStatus");
    const trackingStatus = document.getElementById("trackingStatus");
    const updateCount = document.getElementById("updateCount");
    const lastSent = document.getElementById("lastSent");
    const coordinates = document.getElementById("coordinates");
    const eventName = document.getElementById("eventName");
    const eventDetails = document.getElementById("eventDetails");

    let allRaces = [];
    let watchId = null;
    let sendCount = 0;
    let lastSendTime = 0;
    let lastPosition = null;
    let sendInterval = null;

    const SEND_INTERVAL_MS = 2000;

    async function loadFleetEntries() {
        try {
            const res = await fetch("/data/fleet.json");
            if (!res.ok) throw new Error("Failed to load fleet");
            const data = await res.json();
            const entries = data.entries || [];

            eventName.textContent = data.event || "Finn Racing Event";
            eventDetails.textContent = `${data.club || ""} • ${data.location || ""}`;

            entrySelect.innerHTML = '<option value="">-- Select from fleet or enter manually --</option>';

            entries.forEach((entry, idx) => {
                const opt = document.createElement("option");
                opt.value = idx;
                opt.textContent = `${entry.sailNumber} - ${entry.skipper}`;
                opt.dataset.sailNumber = entry.sailNumber;
                opt.dataset.skipper = entry.skipper;
                entrySelect.appendChild(opt);
            });

            entrySelect.fleetData = entries;

            const savedBoat = localStorage.getItem("finntrack_boatId");
            const savedName = localStorage.getItem("finntrack_boatName");
            if (savedBoat) boatIdInput.value = savedBoat;
            if (savedName) boatNameInput.value = savedName;
        } catch (err) {
            console.log("Fleet data not available, using manual entry only");
            eventName.textContent = "Finn Racing";
            eventDetails.textContent = "";
        }
    }

    entrySelect.addEventListener("change", () => {
        const idx = entrySelect.value;
        if (idx !== "" && entrySelect.fleetData) {
            const entry = entrySelect.fleetData[idx];
            boatIdInput.value = entry.sailNumber;
            boatNameInput.value = entry.skipper;
            localStorage.setItem("finntrack_boatId", entry.sailNumber);
            localStorage.setItem("finntrack_boatName", entry.skipper);
        }
    });

    async function loadRaces() {
        try {
            const races = await FinnAPI.getRaces();
            allRaces = races;

            raceSelect.innerHTML = "";

            if (races.length === 0) {
                const opt = document.createElement("option");
                opt.value = "";
                opt.textContent = "No races available";
                raceSelect.appendChild(opt);
                return;
            }

            races.forEach(race => {
                const opt = document.createElement("option");
                opt.value = race.id;
                opt.textContent = race.name;
                raceSelect.appendChild(opt);
            });
        } catch (err) {
            showError("Failed to load race list: " + err.message);
            raceSelect.innerHTML = '<option value="">Error loading races</option>';
        }
    }

    selectAllBtn.addEventListener("click", () => {
        for (const opt of raceSelect.options) {
            opt.selected = true;
        }
    });

    clearSelectionBtn.addEventListener("click", () => {
        for (const opt of raceSelect.options) {
            opt.selected = false;
        }
    });

    function getSelectedRaceIds() {
        return Array.from(raceSelect.selectedOptions).map(o => o.value).filter(v => v);
    }

    function showError(msg) {
        errorMsg.textContent = msg;
        errorMsg.style.display = "block";
    }

    function hideError() {
        errorMsg.style.display = "none";
    }

    function setGpsStatus(status, type) {
        gpsStatus.textContent = status;
        gpsStatus.className = "status-value status-" + type;
    }

    function setTrackingStatus(status, type) {
        trackingStatus.textContent = status;
        trackingStatus.className = "status-value status-" + type;
    }

    async function sendUpdate() {
        if (!lastPosition) return;

        const now = Date.now();
        if (now - lastSendTime < SEND_INTERVAL_MS) return;

        const selectedRaces = getSelectedRaceIds();
        const boatId = boatIdInput.value.trim();

        if (selectedRaces.length === 0 || !boatId) return;

        const promises = selectedRaces.map(raceId => {
            const payload = {
                raceId: raceId,
                boatId: boatId,
                boatName: boatNameInput.value.trim() || undefined,
                lat: lastPosition.coords.latitude,
                lon: lastPosition.coords.longitude,
                sog: lastPosition.coords.speed != null ? lastPosition.coords.speed * 1.94384 : undefined,
                cog: lastPosition.coords.heading != null ? lastPosition.coords.heading : undefined,
                t: now
            };

            return fetch(API_BASE + "/update?key=" + API_KEY, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + API_KEY
                },
                body: JSON.stringify(payload)
            });
        });

        try {
            const results = await Promise.all(promises);
            const allOk = results.every(r => r.ok);

            if (allOk) {
                sendCount++;
                lastSendTime = now;
                updateCount.textContent = `${sendCount} (${selectedRaces.length} races)`;
                lastSent.textContent = new Date().toLocaleTimeString();
                hideError();
            } else {
                showError("Some updates failed");
            }
        } catch (err) {
            showError("Network error: " + err.message);
        }
    }

    function onPosition(position) {
        lastPosition = position;

        const lat = position.coords.latitude.toFixed(6);
        const lng = position.coords.longitude.toFixed(6);
        const accuracy = position.coords.accuracy.toFixed(0);
        const speed = position.coords.speed != null
            ? (position.coords.speed * 1.94384).toFixed(1) + " kn"
            : "—";

        coordinates.textContent = `${lat}, ${lng} (±${accuracy}m) | ${speed}`;

        setGpsStatus("Active", "ok");
    }

    function onPositionError(error) {
        let msg = "Unknown error";
        switch (error.code) {
            case error.PERMISSION_DENIED:
                msg = "Permission denied";
                setGpsStatus("Denied", "error");
                break;
            case error.POSITION_UNAVAILABLE:
                msg = "Position unavailable";
                setGpsStatus("Unavailable", "error");
                break;
            case error.TIMEOUT:
                msg = "Timeout";
                setGpsStatus("Timeout", "pending");
                break;
        }
        showError("GPS error: " + msg);
    }

    function startTracking() {
        const boatId = boatIdInput.value.trim();
        const selectedRaces = getSelectedRaceIds();

        if (!boatId) {
            showError("Please enter your Boat ID / Sail Number");
            return;
        }

        if (selectedRaces.length === 0) {
            showError("Please select at least one race");
            return;
        }

        hideError();

        localStorage.setItem("finntrack_boatId", boatId);
        localStorage.setItem("finntrack_boatName", boatNameInput.value.trim());

        if (!navigator.geolocation) {
            showError("Geolocation is not supported by this browser");
            return;
        }

        setGpsStatus("Requesting...", "pending");
        setTrackingStatus("Starting...", "pending");

        watchId = navigator.geolocation.watchPosition(
            onPosition,
            onPositionError,
            {
                enableHighAccuracy: true,
                maximumAge: 1000,
                timeout: 10000
            }
        );

        sendInterval = setInterval(sendUpdate, SEND_INTERVAL_MS);

        startBtn.style.display = "none";
        stopBtn.style.display = "block";
        setTrackingStatus("Active", "ok");

        boatIdInput.disabled = true;
        boatNameInput.disabled = true;
        raceSelect.disabled = true;
        entrySelect.disabled = true;
    }

    function stopTracking() {
        if (watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }

        if (sendInterval !== null) {
            clearInterval(sendInterval);
            sendInterval = null;
        }

        startBtn.style.display = "block";
        stopBtn.style.display = "none";
        setTrackingStatus("Stopped", "error");
        setGpsStatus("Stopped", "error");

        boatIdInput.disabled = false;
        boatNameInput.disabled = false;
        raceSelect.disabled = false;
        entrySelect.disabled = false;
    }

    startBtn.addEventListener("click", startTracking);
    stopBtn.addEventListener("click", stopTracking);

    loadFleetEntries();
    loadRaces();
})();
</script>

</body>
</html>
