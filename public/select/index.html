<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FinnTrack – Select Boat & Race</title>
    <link rel="stylesheet" href="/css/style.css" />
    <style>
        .selection-container {
            max-width: 600px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .selection-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
        }

        .form-group select, .form-group input {
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-group select:focus, .form-group input:focus {
            outline: none;
            border-color: #007acc;
        }

        .boat-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            flex: 1;
            padding: 1rem;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background: #005fa3;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #5a6268;
        }

        .event-info {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: #e7f3ff;
            border-radius: 6px;
        }

        .event-info h2 {
            margin: 0 0 0.5rem 0;
            color: #007acc;
        }

        .event-info p {
            margin: 0;
            color: #666;
        }

        .hidden {
            display: none;
        }

        .api-status {
            margin-top: 1rem;
            font-size: 0.75rem;
            color: #888;
            text-align: center;
        }
    </style>
</head>

<body>

<header>
    <div class="brand">FinnTrack</div>
    <nav>
        <a href="/">Live</a>
        <a href="/replay">Replay</a>
        <a href="/select">Join Race</a>
    </nav>
</header>

<main>
    <div class="selection-container">

        <div id="eventInfo" class="event-info">
            <h2 id="eventName">Loading...</h2>
            <p><span id="eventClub">Loading...</span> • <span id="eventLocation">Loading...</span></p>
        </div>

        <form class="selection-form" id="selectionForm">

            <div class="form-group">
                <label for="boatSelect">Select Your Boat:</label>
                <select id="boatSelect" required>
                    <option value="">Loading boats...</option>
                </select>
                <div id="boatInfo" class="boat-info hidden">
                    <strong id="selectedBoatName"></strong><br>
                    Skipper: <span id="selectedSkipper"></span><br>
                    Country: <span id="selectedCountry"></span>
                </div>
            </div>

            <div class="form-group">
                <label for="raceSelect">Select Race:</label>
                <select id="raceSelect" required>
                    <option value="">Loading races...</option>
                </select>
            </div>

            <div class="action-buttons">
                <button type="button" class="btn secondary" onclick="history.back()">Back</button>
                <button type="submit" class="btn" id="continueBtn">Continue to Live Tracking</button>
            </div>

        </form>

        <div class="api-status">
            API: <span id="apiBase"></span>
        </div>
    </div>
</main>

<script src="/js/config.js"></script>
<script src="/js/api.js"></script>
<script>
document.getElementById("apiBase").textContent = FinnAPI.apiBase || "(not loaded)";

(function() {
    const boatSelect = document.getElementById('boatSelect');
    const raceSelect = document.getElementById('raceSelect');
    const boatInfo = document.getElementById('boatInfo');
    const eventName = document.getElementById('eventName');
    const eventClub = document.getElementById('eventClub');
    const eventLocation = document.getElementById('eventLocation');
    const selectedBoatName = document.getElementById('selectedBoatName');
    const selectedSkipper = document.getElementById('selectedSkipper');
    const selectedCountry = document.getElementById('selectedCountry');
    const continueBtn = document.getElementById('continueBtn');
    const selectionForm = document.getElementById('selectionForm');

    let fleetData = null;

    async function loadFleetData() {
        try {
            const response = await fetch('/data/fleet.json');
            fleetData = await response.json();

            eventName.textContent = fleetData.event || 'Finn Racing Event';
            eventClub.textContent = fleetData.club || 'Racing Club';
            eventLocation.textContent = fleetData.location || 'Location';

            boatSelect.innerHTML = '<option value="">Select your boat...</option>';

            if (fleetData.entries) {
                fleetData.entries.forEach(entry => {
                    const option = document.createElement('option');
                    option.value = entry.sailNumber;
                    option.textContent = `${entry.sailNumber} - ${entry.skipper} (${entry.boatName})`;
                    boatSelect.appendChild(option);
                });
            }

        } catch (error) {
            console.error('Failed to load fleet data:', error);
            eventName.textContent = 'Failed to load event data';
            boatSelect.innerHTML = '<option value="">Failed to load boats</option>';
        }
    }

    async function loadRaces() {
        try {
            const races = await FinnAPI.getRaces();
            raceSelect.innerHTML = '<option value="">Select a race...</option>';
            
            if (races && races.length > 0) {
                races.forEach(race => {
                    const option = document.createElement('option');
                    option.value = race.id;
                    option.textContent = race.name;
                    raceSelect.appendChild(option);
                });
            } else {
                raceSelect.innerHTML = '<option value="">No races available</option>';
            }
        } catch (error) {
            console.error('Failed to load races:', error);
            raceSelect.innerHTML = '<option value="">Failed to load races</option>';
        }
    }

    boatSelect.addEventListener('change', function() {
        if (this.value && fleetData) {
            const selectedBoat = fleetData.entries.find(entry => entry.sailNumber === this.value);
            if (selectedBoat) {
                selectedBoatName.textContent = selectedBoat.boatName || selectedBoat.sailNumber;
                selectedSkipper.textContent = selectedBoat.skipper || 'Unknown';
                selectedCountry.textContent = selectedBoat.country || 'Unknown';
                boatInfo.classList.remove('hidden');
            }
        } else {
            boatInfo.classList.add('hidden');
        }
    });

    selectionForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const selectedBoat = boatSelect.value;
        const selectedRace = raceSelect.value;

        if (!selectedBoat || !selectedRace) {
            alert('Please select both a boat and a race');
            return;
        }

        localStorage.setItem('selectedBoat', selectedBoat);
        localStorage.setItem('selectedRace', selectedRace);

        window.location.href = '/?race=' + encodeURIComponent(selectedRace) + '&boat=' + encodeURIComponent(selectedBoat);
    });

    loadFleetData();
    loadRaces();
})();
</script>

</body>
</html>
